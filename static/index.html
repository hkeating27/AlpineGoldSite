<!DOCTYPE html>
<html>
<head>
  <title>Referral Form</title>
  <style>body{font-family:Arial,sans-serif;margin:20px;}input,button,a{margin:5px 0;display:block;}#user-status{margin-bottom:20px;}#view-referrals{margin-top:10px;}</style>
</head>
<body>
  <div id="user-status"></div>
  <h2>Referral Form</h2>
  <label>First Name:</label><input type="text" id="first_name" required>
  <label>Last Name:</label><input type="text" id="last_name" required>
  <label>Referred By:</label><input type="text" id="referred_by" placeholder="Type who referred you">
  <button onclick="submitForm()">Submit</button>
  <a id="view-referrals" href="#" style="display:none;">View Your Referrals</a>
  <script>
    document.addEventListener('DOMContentLoaded',()=>{
      fetch('/whoami',{credentials:'include'}).then(r=>r.json()).then(d=>{if(d.username){document.getElementById('user-status').innerHTML=`Logged in as <a href="/login?ref=${encodeURIComponent(d.username)}">${d.username}</a> | <a href="/logout">Log out</a>`;let v=document.getElementById('view-referrals');v.href=`/referrals?referred_by=${encodeURIComponent(d.username)}`;v.style.display='block';}});
      const p=new URLSearchParams(window.location.search),ref=p.get('ref')||'',ri=document.getElementById('referred_by');if(ref){ri.value=ref;ri.readOnly=true;window.history.replaceState(null,document.title,window.location.pathname);}  
    });
    function submitForm(){const d={first_name:document.getElementById('first_name').value,last_name:document.getElementById('last_name').value,referred_by:document.getElementById('referred_by').value};fetch('/add',{method:'POST',credentials:'include',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)}).then(r=>{if(!r.ok)throw'';return r.text()}).then(m=>{alert(m);document.getElementById('first_name').value='';document.getElementById('last_name').value='';}).catch(()=>alert('Error'));}
  </script>
</body>
</html>
