<!DOCTYPE html>
<html>
<head>
  <title>Your Referrals</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #query_referrer { display: none; }           /* hide the input */
    #logout { margin-top: 20px; display: block; }
  </style>
  <div id="login-status" style="margin-bottom:1em;"></div>

</head>
<body>
  <h2>People You’ve Referred</h2>

  <!-- This is hidden; we auto‑fill it from ?referred_by= -->
  <input type="text" id="query_referrer">

  <button id="get_list_btn" onclick="getReferred()">Get List</button>

  <ul id="result_list"></ul>

  <a id="logout" href="/logout">Log out</a>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      const ref = params.get('referred_by') || '';

      if (!ref) {
        // if somehow someone got here without a ref, kick them back to login
        return window.location.href = `/login`;
      }

      // fill hidden field and lock it
      const input = document.getElementById('query_referrer');
      input.value = ref;
      input.readOnly = true;

      // immediately fetch their list
      getReferred();
    });
      // when page loads
      document.addEventListener('DOMContentLoaded', () => {
        // 1) show whoami
        fetch('/whoami', { credentials: 'include' })
          .then(r => r.json())
          .then(data => {
            if (data.username) {
              document.getElementById('login-status')
                .textContent = `Logged in as ${data.username}`;
            }
          });
      
        // 2) your existing auto‑fill + getReferred() logic…
      });
    function getReferred() {
      const ref = document.getElementById('query_referrer').value;
      fetch(`/get_by_referrer?referred_by=${encodeURIComponent(ref)}`)
        .then(res => {
          if (res.status === 401 || res.status === 403) {
            // not logged in or wrong user → back to login
            return window.location.href = `/login?ref=${encodeURIComponent(ref)}`;
          }
          if (!res.ok) throw new Error();
          return res.json();
        })
        .then(data => {
          const list = document.getElementById('result_list');
          list.innerHTML = '';
          if (data.length === 0) {
            list.innerHTML = '<li>No one yet—share your code!</li>';
            return;
          }
          data.forEach(([first, last]) => {
            const li = document.createElement('li');
            li.textContent = `${first} ${last}`;
            list.appendChild(li);
          });
        })
        .catch(() => {
          alert('Error retrieving your list');
        });
    }
  </script>
</body>
</html>
